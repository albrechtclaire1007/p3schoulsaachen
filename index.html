<!DOCTYPE html>
<html lang="lb">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>P3 – Schoulsaachen</title>
<style>
  /* Font */
  @font-face{
    font-family:'Schoulschrëft';
    src:url('https://raw.githubusercontent.com/albrechtclaire1007/schoulschreft/main/schoulschreft_bold%5B2%5D.TTF') format('truetype');
    font-weight:bold; font-display:swap;
  }

  :root{
    --blue-mid:#8ab6d9; --blue-light:#cde4f5; --blue-dark:#4f7ca0;
    --ink:#173c57; --white:#fff; --ok:#b7f0c8; --bad:#ffcccc;
    --border:3px;
    /* genre colours */
    --masc:#4C78A8;    /* de/den */
    --fem:#E46BA0;     /* d' (for our set) */
  }

  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; outline:none;}
  html,body{height:100%; margin:0; background:linear-gradient(135deg,var(--blue-light) 0%,var(--blue-mid) 50%,var(--blue-dark) 100%); color:var(--ink); font-family:'Schoulschrëft', Arial, sans-serif;}

  /* Top bar (P1 style) */
  .top{
    position:sticky; top:8px; z-index:10; display:flex; gap:10px; align-items:center; justify-content:center;
    background:var(--white); border:var(--border) solid var(--blue-dark); border-radius:18px;
    padding:.35rem .6rem; margin:10px auto; width:fit-content; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .iconBtn{
    border:var(--border) solid var(--ink); background:var(--white); color:var(--ink);
    padding:.25rem .7rem; border-radius:14px; cursor:pointer; font-size:1.4rem; line-height:1;
    min-width:2.4rem; display:grid; place-items:center;
  }
  .iconBtn:active{ transform:scale(.98); }
  .flow{opacity:.9; font-size:1rem; padding:0 .4rem; min-width:10ch; text-align:center;}
  .hidden{display:none!important;}

  .wrap{
    min-height:100%; display:flex; flex-direction:column; align-items:center; gap:2.2vmin;
    padding:2.5vmin 3vmin 4vmin;
  }
  h1{margin:.2rem 0 0; text-align:center; font-size:clamp(1.8rem,6vmin,4rem); color:var(--ink);}

  .btn{
    border:var(--border) solid var(--ink); background:var(--white); color:var(--ink);
    padding:.45rem .85rem; border-radius:14px; cursor:pointer; font-size:1.05rem;
    font-family:'Schoulschrëft', Arial, sans-serif;
  }
  .btn:active{ transform:scale(.98); }

  .flash-good{ background:var(--ok)!important; border-color:var(--ok)!important; }
  .flash-bad{ background:var(--bad)!important; border-color:var(--bad)!important; }

  /* ---------- GAME 1 (3 rows words, 2 rows images) ---------- */
  .g1wrap{width:96vw; max-width:1400px; display:flex; flex-direction:column; gap:1.6vmin;}
  /* Words grid: 3 rows, auto columns */
  .wordGrid{
    display:grid;
    grid-auto-flow:column;
    grid-template-rows:repeat(3, minmax(40px, auto));
    gap:1vmin;
    justify-content:center;
    align-content:center;
  }
  .wordCard{
    background:#fff; border:5px solid var(--blue-mid); border-radius:18px;
    padding:.5rem .9rem; text-align:center; font-size:clamp(1rem,2.6vmin,1.4rem);
    cursor:grab; box-shadow:0 6px 20px rgba(0,0,0,.08); display:flex; align-items:center; justify-content:center;
    min-height:40px; white-space:nowrap;
  }
  .wordCard.selected{ outline:5px solid var(--blue-dark); }

  /* Images grid: 2 rows, smaller tiles */
  .imgGrid{
    display:grid;
    grid-auto-flow:column;
    grid-template-rows:repeat(2, minmax(80px, 1fr));
    gap:1.1vmin;
    justify-content:center;
    align-content:center;
  }
  .imgToken{
    background:#fff; border:6px solid var(--blue-mid); border-radius:18px;
    aspect-ratio:1/1; display:grid; place-items:center; cursor:pointer;
    transition:transform .08s ease; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:4px;
    width:min(16vmin,140px);
    height:min(16vmin,140px);
  }
  .imgToken img{ width:70%; height:70%; object-fit:contain; }
  .imgToken:active{ transform:scale(.97); }

  .g1-controls{display:flex; gap:.6rem; align-items:center; justify-content:center; flex-wrap:wrap;}
  .toggle{ display:flex; align-items:center; gap:.4rem; }

  /* ---------- Shared big boxes ---------- */
  .bigBox{
    width:min(64vmin, 86%); aspect-ratio:1/1; background:#fff; border:10px solid var(--blue-mid);
    border-radius:32px; display:grid; place-items:center; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .bigBox img{ width:80%; height:80%; object-fit:contain; }

  /* ---------- GAME 2 (spelling) ---------- */
  .bigBox.medium{ width:min(52vmin, 78%); }
  .bigBox.medium img{ width:66%; height:66%; }
  .slots{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; padding:.2rem .4rem; }
  .slot{
    min-width:3.1rem; min-height:3.8rem; border-bottom:6px solid var(--ink);
    display:grid; place-items:center; font-size:clamp(1.8rem,5.6vmin,3rem);
  }
  .letters{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; }
  .letter{
    background:#fff; border:4px solid var(--ink); border-radius:12px; padding:.3rem .5rem;
    cursor:pointer; font-size:clamp(1.8rem,5.6vmin,3rem); min-width:3.1rem; text-align:center;
  }

  /* ---------- GAME 3 ---------- */
  .row2{ display:flex; gap:min(4vmin,28px); align-items:center; justify-content:center; flex-wrap:wrap; width:96vw; max-width:1200px; }
  .labelBig{ font-size:clamp(2rem,5.6vmin,3.2rem); text-align:center; margin:.4rem 0 1rem; }
  .choices{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; }
  .choice{
    background:#fff; border:4px solid var(--ink); border-radius:12px; padding:.35rem .75rem;
    cursor:pointer; font-size:clamp(1.6rem,4.8vmin,2.2rem); font-family:'Schoulschrëft', Arial, sans-serif;
  }
  .score{ font-size:clamp(1rem,2.4vmin,1.2rem); opacity:.85; text-align:center; }

  /* ---------- GAME 4 (plural with gender frame + zwee/zwou + stacked plurals, left aligned) ---------- */
  .genreFrame{
    border:10px solid var(--masc); border-radius:28px; width:min(56vmin,84%); aspect-ratio:10/4;
    display:grid; place-items:center; background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.08);
    padding:1vmin; text-align:center; font-size:clamp(1.8rem,5.4vmin,3rem);
  }
  .pluPanel{
    width:min(92vw, 900px);
    display:grid; grid-template-columns:1fr 1fr; gap:min(4vmin,28px);
    align-items:start; justify-items:center;
    padding:1vmin 0;
  }
  .twoRow{ display:flex; gap:.8rem; justify-content:center; align-items:center; width:100%; }
  .stackLeft{ display:flex; flex-direction:column; gap:.8rem; align-items:flex-start; width:100%; }
  .choice.small{ font-size:clamp(1.4rem,4.2vmin,2rem); padding:.3rem .6rem; }
  .choice.toggle.selected{ outline:4px solid var(--blue-dark); }
  .btn[disabled]{ opacity:.5; pointer-events:none; }

  /* ---------- GAME 5 ---------- */
  .inlineRow{ display:flex; align-items:center; justify-content:center; gap:min(2.4vmin,18px); flex-wrap:wrap; }
  .numSq, .colSq{
    display:grid; place-items:center; width:min(18vmin,160px); aspect-ratio:1/1;
    border:8px solid var(--blue-mid); border-radius:18px; background:#fff; font-size:clamp(2rem,5vmin,3rem);
    box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .miniImg{
    display:grid; place-items:center; width:min(26vmin,240px); aspect-ratio:1/1;
    border:8px solid var(--blue-mid); border-radius:18px; background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .miniImg img{ width:85%; height:85%; object-fit:contain; }
  .verb{ display:inline-block; padding:.2rem .8rem; border:6px solid var(--blue-mid); border-radius:16px; background:#fff; font-size:clamp(2rem,5vmin,3rem); }
  .sentText{ margin-top:10px; font-size:clamp(1.6rem,4.6vmin,2.2rem); text-align:center; min-height:2.4rem; }

  /* ---------- Responsive tweaks ---------- */
  @media (max-width: 420px){
    .wordGrid{ grid-template-rows:repeat(3, minmax(36px, auto)); }
    .imgGrid{ grid-template-rows:repeat(2, minmax(72px, 1fr)); }
    .imgToken{ width:min(18vmin,120px); height:min(18vmin,120px); }
    .slot{ min-width:2.6rem; min-height:3.2rem; }
    .letter{ min-width:2.6rem; }
  }
</style>
</head>
<body>

<!-- Top nav -->
<div class="top">
  <button class="iconBtn" id="prev">◀</button>
  <span class="flow" id="flowLabel">1. Spill</span>
  <button class="iconBtn" id="next">▶</button>
</div>

<!-- GAME 1 -->
<section class="wrap" id="g1">
  <h1>Zéi d’Wuert bei d’Bild</h1>
  <div class="g1wrap">
    <div class="wordGrid" id="wordGrid" aria-label="Wierder"></div>
    <div class="imgGrid" id="imgGrid" aria-label="Biller"></div>
    <div class="g1-controls">
      <label class="toggle"><input type="checkbox" id="soundToggle" checked> Toun un/aus</label>
    </div>
  </div>
</section>

<!-- GAME 2 -->
<section class="wrap hidden" id="g2">
  <h1>Schreif d’Wuert</h1>
  <div class="bigBox medium"><img id="spellImg" alt=""></div>
  <div class="slots" id="spellSlots"></div>
  <div class="letters" id="spellBank"></div>
  <div><button class="btn" id="spellNext">Weider</button></div>
</section>

<!-- GAME 3 -->
<section class="wrap hidden" id="g3">
  <h1>Wiel den Artikel</h1>
  <div class="row2">
    <div class="bigBox" style="width:min(46vmin,70%);"><img id="artImg" alt=""></div>
    <div style="min-width:min(46vmin, 70%); max-width:520px;">
      <div class="labelBig" id="artWord">_____ Numm</div>
      <div class="choices" id="artChoices"></div>
      <div class="score" id="artScore">Punkten: 0</div>
      <div style="text-align:center; margin-top:12px;"><button class="btn" id="artNext">Weider</button></div>
    </div>
  </div>
</section>

<!-- GAME 4 -->
<section class="wrap hidden" id="g4">
  <h1>De Pluriel vun de Schoulsaachen</h1>
  <div class="genreFrame" id="pluSingFrame">_____</div>

  <!-- 2-column panel: left = zwee/zwou, right = plural options (stacked, left-aligned) -->
  <div class="pluPanel">
    <div class="twoRow">
      <button class="choice small toggle" id="btnZwee">zwee</button>
      <button class="choice small toggle" id="btnZwou">zwou</button>
    </div>
    <div class="stackLeft" id="pluChoices"></div>
  </div>

  <div class="score" id="pluScore">Punkten: 0</div>
  <div><button class="btn" id="pluNext" disabled>Weider</button></div>
  <div class="note">(Wiel d’richteg Zuel + Pluriel. Du kriss e Punkt wann béid richteg sinn.)</div>
</section>

<!-- GAME 5 -->
<section class="wrap hidden" id="g5">
  <h1>Lies de Saz</h1>
  <div class="inlineRow" id="sentRow">
    <div class="numSq" id="sentNum">3</div>
    <div class="miniImg"><img id="sentImg" alt=""></div>
    <span class="verb">sinn</span>
    <div class="colSq" id="sentCol"></div>
  </div>
  <div style="display:flex; gap:.6rem; justify-content:center; margin-top:10px;">
    <button class="btn" id="sentNew">Nei Kombinatioun</button>
    <button class="btn" id="sentCheck">Check</button>
  </div>
  <div class="sentText" id="sentText"></div>
</section>

<audio id="speaker" preload="auto"></audio>

<script>
/* ---------- DATA ---------- */
const AUDIO_BASE = "https://github.com/albrechtclaire1007/p3schoulsaachen/raw/refs/heads/main/";
const AUDIO_FILES = {
  "d'Buch":"BUCH.mp3","de Bläistëft":"Bläistëft.mp3","de Classeur":"Classeuren.mp3","de Gummi":"GUMMI.mp3",
  "d'Heft":"HEFT.mp3","d'Kräid":"KRÄID.mp3","d'Léierin":"léierin.mp3","de Lineal":"LINEAL.mp3",
  "d'Blat Pabeier":"PABEIER.mp3","d'Schachtel":"SCHACHTEL.mp3","d'Schéier":"SCHEIER.mp3",
  "de Schoulsak":"Schoulsak.mp3","de Spëtzer":"spëtzer.mp3","d'Tafel":"tafel.mp3",
  "d'Tuschfaarf":"tuschfaarf.mp3","d'Bläistëftsfaarf":"blaischteftsfaarf.mp3"
};

const ITEMS = [
  {id:'blaisteft',   label:"de Bläistëft",        img:"https://i.postimg.cc/SnZrXnyQ/Bl-ist-ft.png"},
  {id:'blaisteftsf', label:"d'Bläistëftsfaarf",   img:"https://i.postimg.cc/Bjhg8jqv/Bl-ist-ftsfaarwen.png"},
  {id:'buch',        label:"d'Buch",              img:"https://i.postimg.cc/HrS2Jrpx/Buch.png"},
  {id:'classeur',    label:"de Classeur",         img:"https://i.postimg.cc/CRvNZRF5/Classeur.png"},
  {id:'gummi',       label:"de Gummi",            img:"https://i.postimg.cc/VJ7RSJY5/Gummi.png"},
  {id:'heft',        label:"d'Heft",              img:"https://i.postimg.cc/SnZrXnyX/Heft.png"},
  {id:'kraid',       label:"d'Kräid",             img:"https://i.postimg.cc/qNmLtNkC/Kr-id.png"},
  {id:'leierin',     label:"d'Léierin",           img:"https://i.postimg.cc/YvX34vpW/L-ierin.png"},
  {id:'lineal',      label:"de Lineal",           img:"https://i.postimg.cc/tsr51sX6/Lineal.png"},
  {id:'blat',        label:"d'Blat Pabeier",      img:"https://i.postimg.cc/mPdwcPbM/Pabeier.png"},
  {id:'schachtel',   label:"d'Schachtel",         img:"https://i.postimg.cc/w1WVt16D/Schachtel.png"},
  {id:'scheier',     label:"d'Schéier",           img:"https://i.postimg.cc/mPdwcPbY/Sch-ier.png"},
  {id:'schoulsak',   label:"de Schoulsak",        img:"https://i.postimg.cc/bZ6TGZz0/Schoulsak.png"},
  {id:'spetzer',     label:"de Spëtzer",          img:"https://i.postimg.cc/pm0Z9m2B/Sp-tzer.png"},
  {id:'tafel',       label:"d'Tafel",             img:"https://i.postimg.cc/rDhJdD8J/Tafel.png"},
  {id:'tuschfaarf',  label:"d'Tuschfaarf",        img:"https://i.postimg.cc/bD9MmGtQ/15.png"}
];

/* Articles & Plurals (skip items without plural in plural-based games) */
const LEXICON = {
  classeur:    { article:"de",  noun:"Classeur",         plural:"Classeuren" },
  schoulsak:   { article:"de",  noun:"Schoulsak",        plural:"Schoulsäck" },
  scheier:     { article:"d'",  noun:"Schéier",          plural:"Schéieren" },
  tafel:       { article:"d'",  noun:"Tafel",            plural:"Tafelen" },
  leierin:     { article:"d'",  noun:"Léierin",          plural:"Léierinnen" },
  schachtel:   { article:"d'",  noun:"Schachtel",        plural:"Schachtelen" },
  tuschfaarf:  { article:"d'",  noun:"Tuschfaarf",       plural:"Tuschfaarwen" },
  blaisteftsf: { article:"d'",  noun:"Bläistëftsfaarf",  plural:"Bläistëftsfaarwen" },
  blaisteft:   { article:"de",  noun:"Bläistëft",        plural:"Bläistëfter" },
  lineal:      { article:"de",  noun:"Lineal",           plural:"Linealen" },
  buch:        { article:"d'",  noun:"Buch",             plural:"Bicher" }
  // left out: gummi, kraid, blat, spetzer (until confirmed)
};

/* Colours & numbers for Game 5 */
const COLOURS = [
  {name:"blo",  hex:"#4C78A8"},
  {name:"rout", hex:"#E45756"},
  {name:"gréng",hex:"#72B7B2"},
  {name:"giel", hex:"#F1A33C"},
  {name:"rosa", hex:"#E46BA0"},
  {name:"orange",hex:"#F58518"},
  {name:"mof",  hex:"#7E6ACE"},
  {name:"schwaarz", hex:"#2D2D2D"}
];
const NUMBERS = [2,3,4,5,6,7,8,9,10];

/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const speaker = $('#speaker');
async function playSound(src){ try{ if(speaker.src!==src) speaker.src=src; await speaker.play(); }catch(e){} }
function playLabel(label){
  const on = $('#soundToggle')?.checked;
  if(on === false) return; // only Game 1 toggle affects audio
  const f = AUDIO_FILES[label]; if(f) playSound(AUDIO_BASE + encodeURIComponent(f));
}
function shuffle(a){ const r=[...a]; for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }
function stripArticle(label){ return label.replace(/^(d')/i,"").replace(/^(de|den)\s+/i,"").trim(); }
function getLexById(id){
  const base = ITEMS.find(x=>x.id===id);
  const lex  = LEXICON[id] || {};
  return {
    id, label: base.label, img: base.img,
    article: lex.article || (base.label.startsWith("d'") ? "d'" : (base.label.startsWith("den ") ? "den" : "de")),
    noun: lex.noun || stripArticle(base.label),
    plural: lex.plural || null
  };
}
function flash(el, ok){ el.classList.remove('flash-good','flash-bad'); void el.offsetWidth; el.classList.add(ok?'flash-good':'flash-bad'); setTimeout(()=>el.classList.remove('flash-good','flash-bad'), 260); }
function isMasc(article){ return article==="de" || article==="den"; }
function genreColor(article){ return isMasc(article) ? getComputedStyle(document.documentElement).getPropertyValue('--masc').trim() : getComputedStyle(document.documentElement).getPropertyValue('--fem').trim(); }

/* ---------- NAV ---------- */
const pages = ["g1","g2","g3","g4","g5"]; let pageIdx=0;
const flowLabel = $('#flowLabel'), prevBtn = $('#prev'), nextBtn = $('#next');
function updateNav(){ flowLabel.textContent = `${pageIdx+1}. Spill`; prevBtn.classList.toggle('hidden', pageIdx===0); nextBtn.classList.toggle('hidden', pageIdx===pages.length-1); }
function showPage(i){ pageIdx = Math.max(0, Math.min(pages.length-1, i)); pages.forEach((id,idx)=>document.getElementById(id).classList.toggle('hidden', idx!==pageIdx)); updateNav(); }
prevBtn.onclick = ()=> showPage(pageIdx-1);
nextBtn.onclick = ()=> showPage(pageIdx+1);

/* ---------- GAME 1: Zéi d’Wuert bei d’Bild ---------- */
const wordGrid = $('#wordGrid'), imgGrid = $('#imgGrid');
let selectedWord = null;

function buildGame1(){
  wordGrid.innerHTML=""; imgGrid.innerHTML=""; selectedWord=null;

  // Words (3 rows via CSS grid-auto-flow: column)
  const words = shuffle([...ITEMS]);
  words.forEach(it=>{
    const card = document.createElement('div');
    card.className='wordCard';
    card.textContent = it.label;
    card.draggable = true;
    card.addEventListener('click', ()=>{
      playLabel(it.label);
      if(selectedWord===card){ card.classList.remove('selected'); selectedWord=null; return; }
      if(selectedWord) selectedWord.classList.remove('selected');
      selectedWord = card; card.classList.add('selected');
    });
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', it.id); });
    card.dataset.id = it.id;
    wordGrid.appendChild(card);
  });

  // Make all word boxes equal to the longest word width
  requestAnimationFrame(()=>{
    let maxW = 0;
    [...wordGrid.children].forEach(c=>{ maxW = Math.max(maxW, c.offsetWidth); });
    [...wordGrid.children].forEach(c=>{ c.style.minWidth = maxW + 'px'; });
  });

  // Images (2 rows via CSS grid-auto-flow: column)
  const pics = shuffle([...ITEMS]);
  pics.forEach(it=>{
    const tile = document.createElement('div');
    tile.className='imgToken';
    tile.dataset.id = it.id;
    tile.innerHTML = `<img src="${it.img}" alt="${it.label}">`;
    tile.addEventListener('dragover', e=> e.preventDefault());
    tile.addEventListener('drop', e=>{
      e.preventDefault();
      const wid = e.dataTransfer.getData('text/plain');
      checkG1(wid, tile);
    });
    tile.addEventListener('click', ()=>{
      if(!selectedWord) return;
      checkG1(selectedWord.dataset.id, tile, selectedWord);
    });
    imgGrid.appendChild(tile);
  });

  // Adjust on resize
  window.addEventListener('resize', () => {
    [...wordGrid.children].forEach(c=>{ c.style.minWidth=''; });
    let maxW = 0;
    [...wordGrid.children].forEach(c=>{ maxW = Math.max(maxW, c.offsetWidth); });
    [...wordGrid.children].forEach(c=>{ c.style.minWidth = maxW + 'px'; });
  });
}

function checkG1(wordId, tile, wordEl=null){
  const ok = (wordId === tile.dataset.id);
  flash(tile, ok);
  if(ok){
    tile.style.pointerEvents='none'; tile.style.opacity='.9';
    const w = wordEl || [...wordGrid.children].find(x=>x.dataset.id===wordId);
    if(w){ w.style.pointerEvents='none'; w.style.opacity='.5'; w.classList.remove('selected'); if(selectedWord===w) selectedWord=null; }
    const remaining = [...wordGrid.children].some(x=>x.style.pointerEvents!=='none');
    if(!remaining){ setTimeout(()=> showPage(pageIdx+1), 650); }
  } else {
    if(wordEl){ wordEl.classList.remove('selected'); selectedWord=null; }
  }
}

/* ---------- GAME 2: Spell the word ---------- */
const spellImg = $('#spellImg'), spellSlots = $('#spellSlots'), spellBank = $('#spellBank'), spellNext = $('#spellNext');
let bag2 = shuffle([...ITEMS]); let cur2 = null;
function setupSpellRound(){
  if(bag2.length===0){ bag2 = shuffle([...ITEMS]); }
  cur2 = bag2.pop();
  const lex = getLexById(cur2.id);
  const noun = (lex.noun||"").replace(/\s+/g,'');
  if(!noun){ setupSpellRound(); return; }

  spellImg.src = cur2.img; spellImg.alt = lex.label;
  spellSlots.innerHTML=""; spellBank.innerHTML="";
  const letters=[...noun]; const shuffled=shuffle(letters.slice());
  const slotEls = letters.map((_ch,i)=>{
    const s = document.createElement('div'); s.className='slot'; s.dataset.idx=i; s.dataset.ch='';
    s.addEventListener('dragover',e=>e.preventDefault());
    s.addEventListener('drop',e=>{ e.preventDefault(); const ch=e.dataTransfer.getData('text/plain'); if(!s.textContent){ s.textContent=ch; s.dataset.ch=ch; check(); }});
    s.addEventListener('click',()=>{ if(!s.textContent) return; const ch=s.textContent; s.textContent=''; s.dataset.ch=''; addLetter(ch); });
    spellSlots.appendChild(s); return s;
  });
  function addLetter(ch){
    const l = document.createElement('div'); l.className='letter'; l.textContent=ch; l.draggable=true;
    l.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain', ch));
    l.addEventListener('click',()=>{ const empty=slotEls.find(s=>!s.textContent); if(empty){ empty.textContent=ch; empty.dataset.ch=ch; l.remove(); check(); }});
    spellBank.appendChild(l);
  }
  shuffled.forEach(addLetter);
  function check(){
    const got = slotEls.map(s=>s.dataset.ch).join('');
    if(got.length!==letters.length) return;
    const ok = (got===letters.join(''));
    flash(spellImg.parentElement, ok);
    if(ok) setTimeout(setupSpellRound, 500);
  }
}
spellNext.onclick = setupSpellRound;

/* ---------- GAME 3: Article picker with scoring + retry pass ---------- */
const artImg = $('#artImg'), artWord = $('#artWord'), artChoices = $('#artChoices'), artNext = $('#artNext'), artScoreEl = $('#artScore');
let g3Main = shuffle([...ITEMS]);  // first pass (each exactly once)
let g3Retry = [];                  // wrong from first pass
let g3Mode = 'main';               // 'main' or 'retry'
let g3Score = 0;

function setupArtRound(){
  if(g3Mode==='main' && g3Main.length===0){
    if(g3Retry.length){ g3Mode='retry'; g3Main = shuffle(g3Retry); g3Retry = []; }
    else { showPage(pageIdx+1); return; }
  } else if(g3Mode==='retry' && g3Main.length===0){
    showPage(pageIdx+1); return;
  }

  const cur = g3Main.pop();
  const lex = getLexById(cur.id);
  artImg.src = cur.img; artImg.alt = lex.label;
  artWord.textContent = `_____ ${lex.noun}`;
  artChoices.innerHTML = "";
  ["de","den","d'"].sort(()=>Math.random()-.5).forEach(o=>{
    const b = document.createElement('button'); b.className='choice'; b.textContent=o;
    b.onclick = ()=>{
      const ok = (o===lex.article);
      flash(artImg.parentElement, ok);
      if(ok){ g3Score++; updateArtScore(); }
      else if(g3Mode==='main'){ g3Retry.push(cur); }
      setTimeout(setupArtRound, 450);
    };
    artChoices.appendChild(b);
  });
}
function updateArtScore(){ artScoreEl.textContent = `Punkten: ${g3Score}`; }
artNext.onclick = setupArtRound;

/* ---------- GAME 4: Plural with gender frame + zwee/zwou + scoring + retry ---------- */
const pluSingFrame = $('#pluSingFrame'),
      btnZwee = $('#btnZwee'),
      btnZwou = $('#btnZwou'),
      pluChoices = $('#pluChoices'),
      pluNext = $('#pluNext'),
      pluScoreEl = $('#pluScore');

let g4Pool = ITEMS.map(i=>getLexById(i.id)).filter(x=>x.plural); // only items with confirmed plural
let g4Main = shuffle(g4Pool.slice()); // first pass
let g4Retry = [];
let g4Mode = 'main';
let g4Score = 0;

let g4Current = null;
let g4PickTwo = null;     // 'zwee' or 'zwou'
let g4PickPlural = null;  // candidate string

function colorizeFrame(article){
  const col = genreColor(article);
  pluSingFrame.style.borderColor = col;
  pluSingFrame.style.boxShadow = `0 8px 24px rgba(0,0,0,.08), 0 0 0 6px ${col}33`;
}

function resetG4Selections(){
  g4PickTwo = null; g4PickPlural = null;
  [btnZwee, btnZwou].forEach(b=> b.classList.remove('selected','flash-good','flash-bad'));
  [...pluChoices.children].forEach(c=> c.classList.remove('selected','flash-good','flash-bad'));
  setPluNextReady(false);
}

function setPluNextReady(on){
  pluNext.disabled = !on;
}

function maybeEnableNext(){
  setPluNextReady(Boolean(g4PickTwo && g4PickPlural));
}

function pluralDistractors(baseSing, correct){
  const stems = [
    baseSing.replace(/e/g,'ë').replace(/a/g,'ä'),
    baseSing.replace(/ë/g,'e').replace(/ä/g,'a'),
    baseSing
  ];
  const suffixes=['en','er','s'];
  const cand = new Set();
  stems.forEach(st=> suffixes.forEach(suf=> cand.add(st + suf)));
  cand.delete(correct);
  return shuffle([...cand]).slice(0,3);
}

function setupPluralRound(){
  if(g4Mode==='main' && g4Main.length===0){
    if(g4Retry.length){ g4Mode='retry'; g4Main = shuffle(g4Retry); g4Retry = []; }
    else { showPage(pageIdx+1); return; }
  } else if(g4Mode==='retry' && g4Main.length===0){
    showPage(pageIdx+1); return;
  }

  resetG4Selections();

  g4Current = g4Main.pop();
  pluSingFrame.textContent = g4Current.label; // full with article
  colorizeFrame(g4Current.article);

  btnZwee.onclick = ()=>{
    g4PickTwo = 'zwee';
    btnZwee.classList.add('selected');
    btnZwou.classList.remove('selected');
    maybeEnableNext();
  };
  btnZwou.onclick = ()=>{
    g4PickTwo = 'zwou';
    btnZwou.classList.add('selected');
    btnZwee.classList.remove('selected');
    maybeEnableNext();
  };

  pluChoices.innerHTML = "";
  const wrong = pluralDistractors(g4Current.noun, g4Current.plural);
  const opts = shuffle([g4Current.plural, ...wrong]);
  opts.forEach(o=>{
    const b = document.createElement('button'); b.className='choice small'; b.textContent=o;
    b.style.minWidth='12ch';
    b.onclick=()=>{
      [...pluChoices.children].forEach(x=> x.classList.remove('selected'));
      b.classList.add('selected');
      g4PickPlural = o;
      maybeEnableNext();
    };
    pluChoices.appendChild(b);
  });
}

function evaluateG4(){
  if(!g4Current){ return; }
  if(!(g4PickTwo && g4PickPlural)){
    flash(pluSingFrame, false);
    return;
  }
  const needTwo = isMasc(g4Current.article) ? 'zwee' : 'zwou';
  const ok = (g4PickTwo === needTwo) && (g4PickPlural === g4Current.plural);

  flash(pluSingFrame, ok);
  if(ok){ g4Score++; updatePluScore(); }
  else if(g4Mode==='main'){ g4Retry.push(g4Current); }

  g4Current = null;
  setTimeout(setupPluralRound, 500);
}
function updatePluScore(){ pluScoreEl.textContent = `Punkten: ${g4Score}`; }
pluNext.onclick = evaluateG4;

/* ---------- GAME 5: Number–image–colour + Check ---------- */
const sentNum=$('#sentNum'), sentImg=$('#sentImg'), sentCol=$('#sentCol');
const sentNew=$('#sentNew'), sentCheck=$('#sentCheck'), sentText=$('#sentText');
let curSentence=null;
function numWord(n){ const m={2:"Zwee",3:"Dräi",4:"Véier",5:"Fënnef",6:"Sechs",7:"Siwen",8:"Aacht",9:"Néng",10:"Zéng"}; return m[n]||String(n); }
function buildSentence(){
  const pool = g4Pool.length ? g4Pool : ITEMS.map(x=>getLexById(x.id)).filter(x=>x.plural);
  const it = pool.length ? pool[Math.floor(Math.random()*pool.length)] : getLexById('classeur');
  const n  = NUMBERS[Math.floor(Math.random()*NUMBERS.length)];
  const c  = COLOURS[Math.floor(Math.random()*COLOURS.length)];
  sentNum.textContent = n;
  sentImg.src = ITEMS.find(x=>x.id===it.id).img; sentImg.alt = it.label;
  sentCol.style.background = c.hex;
  sentText.textContent = "";
  curSentence = {n, it, c};
}
sentNew.onclick = buildSentence;
sentCheck.onclick = ()=>{ if(!curSentence) return; sentText.textContent = `${numWord(curSentence.n)} ${curSentence.it.plural} sinn ${curSentence.c.name}.`; };

/* ---------- INIT ---------- */
function init(){
  buildGame1();
  setupSpellRound();

  // Game 3 fresh start
  g3Main = shuffle([...ITEMS]); g3Retry=[]; g3Mode='main'; g3Score=0; updateArtScore(); setupArtRound();

  // Game 4 fresh start
  g4Pool = ITEMS.map(i=>getLexById(i.id)).filter(x=>x.plural);
  g4Main = shuffle(g4Pool.slice()); g4Retry=[]; g4Mode='main'; g4Score=0; updatePluScore(); setupPluralRound();

  buildSentence();
  showPage(0);
}
init();
</script>
</body>
</html>

